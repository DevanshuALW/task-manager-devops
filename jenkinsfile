pipeline {
  agent any
  environment {
    AWS_REGION = 'ap-south-1'
    AWS_ACCOUNT_ID = "${env.AWS_ACCOUNT_ID}" // set in Jenkins global env or credentials
    ECR = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/task-manager"
    IMAGE_TAG = "${env.BUILD_NUMBER}"
  }
  stages {
    stage('Checkout') { steps { checkout scm } }
    stage('Build') {
      steps {
        sh "docker build -t task-manager:${IMAGE_TAG} ."
      }
    }
    stage('Login & Push to ECR') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'aws-ecr-creds', usernameVariable: 'AWS_USER', passwordVariable: 'AWS_SECRET')]) {
          sh """
            aws configure set aws_access_key_id ${AWS_USER}
            aws configure set aws_secret_access_key ${AWS_SECRET}
            aws configure set region ${AWS_REGION}
            aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com
            docker tag task-manager:${IMAGE_TAG} ${ECR}:${IMAGE_TAG}
            docker push ${ECR}:${IMAGE_TAG}
          """
        }
      }
    }
    stage('Deploy Green') {
      steps {
        sh """
          sed 's|<ECR_URI>:{{NEW_TAG}}|${ECR}:${IMAGE_TAG}|g' k8s/deployment-green.yaml > /tmp/deployment-green-${IMAGE_TAG}.yaml
          kubectl apply -f /tmp/deployment-green-${IMAGE_TAG}.yaml
          kubectl rollout status deployment/task-manager-green --timeout=120s
        """
      }
    }
    stage('Optional Canary') {
      steps {
        echo "Canary steps can be automated here (e.g., update canary weight, monitor metrics)."
      }
    }
  }
  post {
    failure { mail to: 'you@example.com', subject: "Build Failed", body: "Check Jenkins console" }
  }
}
